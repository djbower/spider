pipelines:
  custom:
    '{master}':
      - step:
          caches:
            - petsc-double-direct
          script:
            # Packages
            - sudo apt-get update
            - sudo apt-get --fix-missing -yq --no-install-suggests --no-install-recommends --force-yes install libblas-dev liblapack-dev python-numpy
            - sudo apt-get --fix-missing -yq --no-install-suggests --no-install-recommends --force-yes install valgrind

            # PETSc with SUNDIALS quad/direct hacks
            # Bitbucket may have restored the build from cache, so check before rebuilding
            - export PETSC_DIR=$PWD/petsc-double-direct
            - export PETSC_ARCH=arch-test
            - if [ -f "$PETSC_DIR/configure.log" ]; then export PETSC_ALREADY_HERE=y; else export PETSC_ALREADY_HERE=n; fi
            - if [ "$PETSC_ALREADY_HERE" = "n" ]; then git clone https://bitbucket.org/psanan/petsc --depth=1 -b psanan/ts-sundials-quad-hack petsc-double-direct; fi
            - if [ "$PETSC_ALREADY_HERE" = "n" ]; then cd $PETSC_DIR; fi
            - if [ "$PETSC_ALREADY_HERE" = "n" ]; then ./configure --with-fc=0 --with-cxx=0 --with-cc=gcc --download-sundials --download-mpich; fi
            - if [ "$PETSC_ALREADY_HERE" = "n" ]; then make all; fi
            - if [ "$PETSC_ALREADY_HERE" = "n" ]; then make test; fi
            - if [ "$PETSC_ALREADY_HERE" = "n" ]; then cd ..; fi

            # Build SPIDER
            - make -j

            # run valgrind (examine manually!)
            - valgrind ./spider -nstepsmacro 1 -dtmacro_years 10

            # run valgrind for atmosphere (examine manually!)
            #- valgrind ./spider -options_file examples/bower_2019/atmosphere_jeans/bu_input.opts -nstepsmacro 1 -dtmacro_years 0.00001 

            # DJB commmented this out since we can run tests locally and not use up
            # pipeline minutes.  This is particularly important since valgrind does not
            # run on Mojave
            # Test
            - cd tests
            - git clone https://bitbucket.org/dmay/pythontestharness
            - ./runTests.py -d # create default config
            - ./runTests.py -f # Return error code based on test success
definitions:
   caches:
      petsc-double-direct: petsc-double-direct
