\documentclass[12pt,notitlepage]{article}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{natbib}
\usepackage{tikz}
\usepackage{empheq}
\usepackage{cases}

\usepackage{xcolor}
\usepackage{soul}
\definecolor{redhl}{rgb}{1,0.5,0.5}
\definecolor{bluehl}{rgb}{0.75,0.75,1}
\definecolor{greenhl}{rgb}{0.5,1.0,0.5}
\definecolor{tealhl}{rgb}{0.6,0.8,0.8}
\newcommand{\awnote}[1]{\sethlcolor{redhl}\hl{(AW: #1)}}
\newcommand{\dbnote}[1]{\sethlcolor{bluehl}\hl{(DB: #1)}}
\newcommand{\psnote}[1]{\sethlcolor{greenhl}\hl{(PS: #1)}}
\newcommand{\tknote}[1]{\sethlcolor{tealhl}\hl{(TK: #1)}}
\newcommand{\boxedeq}[2]{\begin{empheq}[box={\fboxsep=6pt\fbox}]{align}\label{#1}#2\end{empheq}}

\newcommand{\myemph}[1]{\textbf{#1}}

\begin{document}

\title{Manual and extended notes for SPIDER\\[2ex] \includegraphics[width=0.5\textwidth]{figs/spider_logo}}
\author{Dan J. Bower}

\pagenumbering{Roman}

\maketitle

\tableofcontents
\newpage
\listoffigures
\newpage
\listoftables
\newpage
\pagenumbering{arabic}

%\begin{abstract}
%The abstract text goes here.
%\end{abstract}

\section{Preface}
\input{input/preface}
%\clearpage

\section{Fundamental thermodynamics}
\input{input/basic_thermodynamics}
%\clearpage

\section{Conservation of chemical species}
\input{input/transport}
%\clearpage

\section{Material properties}
\input{input/material_properties}
%\clearpage

%%%%%%%%%%%%%
%%% PRESSURE %%%
%%%%%%%%%%%%%
\section{Hydrostatic pressure}
\fbox{\parbox{\textwidth}{We use the Adams-Williamson equation of state to compute the hydrostatic pressure profile.  This is important because we need to know a relationship between our mesh (originally radius) and the lookup coordinate (pressure).  It is also useful/important for the conversion from radius to mass coordinates and vice versa.}}\\
\subsection{Pressure}
Adams-Williamson equation of state:
\begin{equation}
P = - \frac{\rho_r g}{\beta} (\exp( \beta z )-1)
\end{equation}
where $\rho_r$ is a reference surface density, $g$ gravity which is negative by convention, $\beta$ is a measure of the compressibility of the material, and $z$ is depth.  For Earth, gravity is near constant throughout the mantle and we solve for $\rho_r$ and $\beta$ using a least-squares fit to the density profile of the lower mantle.  Relationship between depth and radius is:
\begin{equation}
z = ro - r \implies \frac{dz}{dr} = -1
\end{equation}
\subsection{Pressure gradient}
\begin{equation}
\frac{dP}{dr} = \frac{dP}{dz} \frac{dz}{dr} = \rho_s g \exp( \beta z )
\end{equation}
\subsection{Density}
\subsubsection{Functional form}
Useful since we can approximate the density \emph{a priori} and use this to convert between radius and mass coordinates:
\begin{equation}
\rho(z) = \rho_s \exp( \beta z )
\end{equation}
\subsubsection{Average density}
Average mantle density $\rho_0$ is convenient to know for the conversion between radius and mass coordinates:
\begin{align}
\frac{4 \pi}{3} \rho_0 (r_o^3-r_i^3) &= 4 \pi \int_{r_i}^{r_o} \rho(r) r^2 dr\\
\rho_0 &= \frac{3 \rho_s}{(r_o^3-r_i^3)} \int_{r_i}^{r_o} \exp( \beta (r_o-r) ) r^2 dr\\
\rho_0 &= \frac{3 \rho_s \exp( \beta r_o )}{(r_o^3-r_i^3)} \int_{r_i}^{r_o} r^2 \exp( -\beta r) dr
\end{align}
Using Wolfram alpha to evaluate the definite integral:
\begin{verbatim}
integrate r^2 exp(-beta*r) dr from r=a to r=b
\end{verbatim}
\begin{equation}
\int_{r_i}^{r_o} r^2 \exp( -\beta r) dr = \frac{\exp(-\beta r_i)(\beta r_i (\beta r_i+2)+2) + \exp(-\beta r_o)(-\beta r_o (\beta r_o+2)-2)}{\beta^3}
\end{equation}
Therefore:
\begin{align}
\rho_0 &= \frac{3 \rho_s \exp( \beta r_o )}{(r_o^3-r_i^3)}
\left[
\frac{\exp(-\beta r_i)(\beta r_i (\beta r_i+2)+2) + \exp(-\beta r_o)(-\beta r_o (\beta r_o+2)-2)}{\beta^3}
\right]\\
\rho_0 &= \frac{3 \rho_s}{\beta^3 (r_o^3-r_i^3)}
\left[
e^{\beta (r_o-r_i)}(\beta r_i (\beta r_i+2)+2) -\beta r_o (\beta r_o+2)-2
\right]
\end{align}
Hence given our simple EOS we can exactly determine the average density of the mantle using the above expression.  \dbnote{This EOS does not perform well at high pressure, and should really be regarded as a fitting function.  Obvious ways to improve on this include using a more sophisticated and accurate EOS, such as the Vinet.}

Look to implement Vinet?  Can we also relate this to mass coordinate?  Vinet EOS is:
\begin{equation}
P = 3 K_{T0} \left( \frac{V}{V_0} \right)^{-\frac{2}{3}} \left[1-\left( \frac{V}{V_0}\right)^\frac{1}{3} \right] \exp \left( \frac{3}{2} ( K_{T0}^\prime-1) \right) \left[1-\left( \frac{V}{V_0}\right)^\frac{1}{3} \right] 
\end{equation}
\begin{equation}
P(r) = \int_r^R \rho(r^\prime) g(r^\prime) dr^\prime
\end{equation}
\begin{equation}
g(r) = \frac{G m(r)}{r^2}
\end{equation}
%\subsubsection{Aside: Sensitivity of EOS to parameters}
%Differentiate with respect to $\beta$ to find the sensitivity of the average density of the shell to the compressibility of the material within the shell.  Again, easiest to do using Wolfram Alpha:
%\begin{verbatim}
%differentiate integrate r^2 exp(-beta*r) dr from r=a to r=b wrt beta
%\end{verbatim}
%\begin{align}
%\frac{d\rho_0}{d\beta} &= \frac{d}{d\beta} \left( \int_{r_i}^{r_o} r^2 \exp( -\beta r) dr \right)\\
%&= e^{- \beta r_i} \left(-\frac{r_i^3}{\beta}-\frac{3r_i^2}{\beta^2}-\frac{6r_i}{\beta^3} \right) + \frac{e^{\beta(-r_i-r_o)}(6e^{\beta r_i} -6e^{\beta r_o})}{\beta^4} + e^{- \beta r_o} \left(\frac{r_o^3}{\beta}+\frac{3r_o^2}{\beta^2}+\frac{6r_o}{\beta^3} \right)
%\end{align}
%\begin{verbatim}
%integrate 3*c*e^(beta)/(1-0.55^3)*r^2 exp(-beta*r) dr from r=0.55 to r=1.0
%\end{verbatim}
%\subsection{Notation}
%Uppercase quantities ($U$, $J$) represents quantities relative to a stationary reference frame.  Lower case quantities are relative to a reference frame moving with the barycentric velocity, $U$.
%%%%
%%%%

%%% TO REMOVE %%%
% this doesn't seem to be going anywhere, and should be eliminated
% when the switch to mass coordinates has been made.
%\section{Analysis of the Lagrangian derivative}
%The LHS is:
%\begin{equation}
%\frac{Ds}{Dt} = \frac{\partial s}{\partial t} + \vec{U} \cdot \nabla s
%\end{equation}
%But in SPIDER (at present) we ignore the second term which is the convective derivative, i.e. the change in entropy due to transport by the flow.  Let's try and determine this second term now.  Use:
%\begin{equation}
%\vec{U} = \phi \vec{U}_m + (1-\phi) \vec{U}_s
%\end{equation}
%and then sub in to eliminate $U_m-U_s$ by using:
%\begin{equation}
%\vec{J}_m = \rho \phi (1-\phi)(\vec{U}_m-\vec{U}_s)
%\end{equation}
%To get:
%\begin{equation}
%\vec{U} \cdot \nabla s = \frac{\vec{J}_m}{\rho(1-\phi)} \cdot \nabla s + \vec{U}_s \cdot \nabla s 
%\end{equation}
%So the first term is only important when relative motion of melt-solid becomes significant, which is around and below the rheological transition.  Now need to find an expression for $\vec{U}_s$!

\subsection{Gravitational potential energy}
The gravitational potential energy per unit mass is:
\begin{equation}
E_{\rm grav} = \frac{\partial U_{\rm grav}}{\partial m} = - \frac{G M(r)}{r} = - |g(r)|r
\end{equation}
where $U_{\mathrm{grav}}$ is gravitational energy, $m$ mass, $G$ gravitational constant, $r$ radius from centre of mass, $M(r)$ integrated mass from centre of mass to $r$, and $g(r)$ acceleration due to gravity as a function of $r$.
Thus, melting influences gravitational potential energy through its affect on $g(r)$, and because $g(r)$ is an integrated quantity it is not sensitive to small changes to the density distribution.  We therefore neglect changes in $E_{\mathrm{grav}}$ for silicate melting in a magma ocean.  However, this term should be included to model mantle-core differentiation because in this case the density contrast between solid and melt components is large.
%%%%
%%%%
%%%%

\section{Mass coordinates}
\fbox{\parbox{\textwidth}{Definition of mass coordinate.}}\\

\noindent
Defined as: \dbnote{4$\pi$ cancels, but check this is OK for scaled masses}
\begin{equation}
\frac{4 \pi}{3} \rho_0 \xi^3 \equiv 4 \pi \int_0^r \rho r^2 dr = m
\end{equation}
Take derivative with respect to r:
\begin{equation}
\frac{4 \pi}{3} \rho_0 3 \xi^2 \frac{d \xi}{d r} = 4 \pi \rho r^2
\end{equation}
Cancel $4 \pi$ and $3$:
\begin{equation}
\rho_0 \xi^2 \frac{d \xi}{d r} = \rho r ^2
\end{equation}
$\rho$ is a function of $r$ or $\xi$, so rearrange and integrate:
\begin{equation}
\int_0^\xi \frac{\rho_0}{\rho} \xi^2 d\xi = \int_0^r r^2 dr = \frac{r^3}{3}
\end{equation}
Finally gives, as in Eq. 30 in \cite{ABE95}:
\begin{equation}
r(\xi) = \left[ 3 \int_0^\xi \frac{\rho_0}{\rho(\xi)} \xi^2 d\xi \right]^\frac{1}{3}
\end{equation}
Note that $\xi$ is referred to by \cite{ABE95} as a ``mass coordinate'' and has \textbf{length dimension}.

%%% TO REMOVE %%%
% I don't think this adds anything
%\subsection{Spherical shell}
%\begin{equation}
%V = \frac{4 \pi}{3} (r_{outer}^3-r_{inner}^3)
%\end{equation}
%\begin{equation}
%r_{outer} = \left( \frac{3V}{4\pi} + r_{inner}^3 \right)^\frac{1}{3}
%\end{equation}
\subsection{Partial derivatives}
\fbox{\parbox{\textwidth}{Determine the mapping between the partial derivatives with respect to radius and with respect to mass coordinate..}}\\

Now want to compute the partial derivatives under the coordinate transformation from $r \rightarrow \xi$, with time $t$ remaining as the second variable, i.e.,
\begin{equation}
(r,t) \rightarrow (\xi,t)
\end{equation}
We use the chain rule.  For the transformation of the spatial derivative, where we explicitly note what is held constant just to be able to compare directly with the formulation in \cite{ABE95}:
\begin{align}
\left( \frac{\partial}{\partial \xi} \right)_t &= \left( \frac{\partial}{\partial r} \right)_t \left( \frac{\partial r}{\partial \xi} \right)_t + \left( \frac{\partial}{\partial t} \right)_r \left( \frac{\partial t}{\partial \xi} \right)_t\\
&= \left( \frac{\partial}{\partial r} \right)_t \left( \frac{\partial r}{\partial \xi} \right)_t
\end{align}
For the transformation of the temporal derivative:
\begin{align}
\left( \frac{\partial}{\partial t} \right)_\xi &= \left( \frac{\partial}{\partial r} \right)_t \left( \frac{\partial r}{\partial t} \right)_\xi + \left( \frac{\partial}{\partial t} \right)_r \left( \frac{\partial t}{\partial t} \right)_\xi\\
&= \left( \frac{\partial}{\partial r} \right)_t \left( \frac{\partial r}{\partial t} \right)_\xi + \left( \frac{\partial}{\partial t} \right)_r, \qquad \text{since}\ \left( \frac{\partial t}{\partial t}\right)_\xi=1
\end{align}
Re-arrange into the form in \cite{ABE95}:
\begin{equation}
\left( \frac{\partial}{\partial r} \right)_t = \left( \frac{\partial \xi}{\partial r} \right)_t \left( \frac{\partial}{\partial \xi} \right)_t = \frac{\rho}{\rho_0} \left( \frac{r}{\xi} \right)^2 \left(\frac{\partial}{\partial \xi} \right)_t
\label{eq:ddr}
\end{equation}
\begin{equation}
 \left( \frac{\partial}{\partial t} \right)_r  = \left( \frac{\partial}{\partial t} \right)_\xi - \left( \frac{\partial r}{\partial t} \right)_\xi  \left( \frac{\partial}{\partial r} \right)_t = \left( \frac{\partial}{\partial t} \right)_\xi - U  \left( \frac{\partial}{\partial r} \right)_t
\end{equation}
where $U$ is the local barycentric velocity in the radial direction.  Thus, the Lagrangian derivatives are replaced by the partial derivative with respect to time, when we use the mass coordinate.
\section{Final equations}
These are what we should solve in SPIDER:
\begin{equation}
\rho T \frac{Ds}{Dt} = -\nabla \cdot \left[ \vec{J}_q + \Delta h (\vec{J}_m + \vec{J}_{cm}) \right]
\end{equation}
Now, transform to the mass coordinates by replacing the Lagrangian with a partial derivative with respect to time:
\begin{equation}
\rho T \left( \frac{\partial s}{\partial t} \right)_\xi = -\nabla \cdot \left[ \vec{J}_q + \Delta h (\vec{J}_m + \vec{J}_{cm}) \right]
\end{equation}
Now expand $\nabla$ operator for spherical coordinates:
\begin{equation}
\rho T \left( \frac{\partial s}{\partial t} \right)_\xi = -\frac{1}{r^2} \frac{\partial}{\partial r} \left( r^2 \left[ \vec{J}_q + \Delta h (\vec{J}_m + \vec{J}_{cm}) \right] \right)
\end{equation}
And replace derivative with respect to $r$ with derivative with respect to $\xi$:
\begin{equation}
\rho T \left( \frac{\partial s}{\partial t} \right)_\xi = - \frac{\rho}{\rho_0 \xi^2} \left(\frac{\partial}{\partial \xi} \right)_t \left( r^2 \left[ \vec{J}_q + \Delta h (\vec{J}_m + \vec{J}_{cm}) \right] \right)
\label{eq:finals}
\end{equation}
This description is known as the ``Lagrangian description'' \citep[e.g.,][]{KWW12} because we are following mass elements.  \dbnote{How to represent this in a finite volume form?}
\subsection{Integral form}
\begin{equation}
\int_V \rho T \left( \frac{\partial s}{\partial t} \right)_\xi dV = - \int_A F \cdot n dA + \int_V \rho H dV
\end{equation}
\subsection{Fluxes}
Mapping to new spatial coordinate:
\begin{equation}
\frac{\partial S}{\partial r}=\frac{\rho}{\rho_0} \left( \frac{r}{\xi} \right)^2 \left(\frac{\partial S}{\partial \xi} \right)_t
\end{equation}
So heat flux becomes:
\begin{equation}
\vec{J}_q=-\rho T \kappa_h \frac{\partial S}{\partial r} = -\rho T \kappa_h \frac{\rho}{\rho_0} \left( \frac{r}{\xi} \right)^2 \left(\frac{\partial S}{\partial \xi} \right)_t
\end{equation}
\dbnote{Probably now makes sense to track $\partial S/\partial \xi$, and integrate this to get $S$ etc.  It's probably easiest to just do as much crunching as possible using $\xi$ rather than $r$ for consistency.}
\subsection{Mesh}
\begin{figure}[!h]
\begin{center}
\include{figs/mesh}
\end{center}
\caption{Schematic representation of the mesh with mass coordinate ($\xi$) or radius $r$ as the spatial dimension.}
\end{figure}
\subsubsection{Relationship to volume (new approach)}
\begin{itemize}
\item We consider elements/cells with fixed mass.
\item Mass of each element is known (prescribed).
\item \textbf{An approximation: hydrostatic/total pressure $P$ is fixed during magma ocean evolution.}  \dbnote{Clearly fails for accreting planet scenario, but in the simplest case can update the hydrostatic pressure each timestep using the same simple EOS as we currently do.}
\begin{itemize}
\item Already in SPIDER, since define radius coordinates and corresponding pressures once during the initialisation.  See Eq.~16 in \cite{BSW18}.
\item We do not recompute the pressure profile due to the evolution of melt fraction (and hence relative contributions of melt versus solid densities) during a model run.
\item Or similarly, it's the differences of melt and solid thermophysical properties at a given pressure, rather than the absolute pressure itself, that is most important for driving the flow.
\item Argument is that melt and solid densities are similar enough to not strongly influence an integrated quantity like pressure.
\item And from a purely pragmatic perspective, we have to know $P$ and $S$ at basic and staggered nodes in order to compute necessary terms for the RHS.
\end{itemize}
\item In the simple case outlined above, we compute density, pressure, and mass by an Adams-Williamson EOS (Eq.~16 in \cite{BSW18}).  \dbnote{Therefore, even for a radial mesh the volume was fixed and also the density, and hence the mass!  Does this partly justify ignoring the convective derivative term in the original formulation?!}
\item More can probably be done here about integrating the hydrostatic .equilibrium equation (see Sect.~\ref{sect:hydrostatic})
\item So assuming we can reasonably determine $P$, and prescribe an initial $S$, we can compute $\rho(P,S)$ at all basic and staggered mesh locations.  \textbf{Knowing $\rho$ and the mass of the elements, and presumably a fixed integration point for $r$ such as the CMB, we can determine the volume of each cell and also the surface areas of the bounding surfaces.}
\item But this could highlight a problem!  Since integrating outwards from the CMB, or inwards from the surface, will not necessarily give us the correct end point of the present-day Earth (since the radius of the surface and core are known well!).
\item \textbf{Two options: switch to test each?}
\begin{enumerate}
\item Assume density of a mass cell is \textbf{constant with time}, i.e. does not respond to changes in melt/solid fraction.  Therefore the volume of the cell will also be constant, and hence the bounding surfaces should correspond to \textbf{time-independent radii}
\item Compute the density of a mass cell, since $\rho(P,S)$ using melt and solid lookup data.  This will result in \textbf{time-dependent radii} for the bounding surfaces, and effectively a planet that can `breathe''.  This might look a bit strange since a planet's surface will move radially in and out as the melt fraction evolves.  \dbnote{And the uncertainties in the EOS, in addition to the overall simplicity of the modelling, probably means this effect is really not important or worthy of modelling (in the case of a fully formed planet).}
\end{enumerate}
\item If we do 1 above, then I think this corresponds closely (or exactly) to the incorrect formulation in the paper?!  Since in both the formulation with $r$ (original) and $\xi$ (new) the bounding surfaces of the elements are assumed to be fixed in time meaning that $\frac{\partial r}{\partial t} = U=0$.  And hence the barycentric velocity is zero and we are justified/consistent when we exclude it from the equation.
\end{itemize}
%%%%%
%%%%%
%%%%%
\section{Hydrostatic equilibrium}
\label{sect:hydrostatic}
\begin{equation}
\frac{dp(r)}{dr} = g(r) \rho(r) = -G \frac{M(r)}{r^2}\rho(r)
\end{equation}
Multiply by $r^2/\rho$ and differentiate with respect to $r$:
\begin{equation}
\frac{d}{dr} \left( \frac{r^2}{\rho(r)} \frac{dp(r)}{dr} \right) = -G \frac{dM(r)}{dr} = -G 4 \pi r^2 \rho(r)
\end{equation}
Rearranging this becomes:
\begin{equation}
\frac{1}{r^2} \frac{d}{dr} \left( \frac{r^2}{\rho}\frac{dp}{dr} \right) = -4 \pi G \rho
\end{equation}
Combined with an EOS of the form $p=p(\rho)$, this is an ordinary second order differential equation for the density or pressure.
%%%%%
%%%%%
%%%%%
\section{Eq. in \cite{ABE93}}
The conversion to mass units means that the Lagrangian derivative becomes the partial derivative:
\begin{equation}
\frac{\partial \omega_i}{\partial t} = -4 \pi \frac{\partial}{\partial m} r^2 \left[ \frac{1-K_i}{K_i+(1-K_i)\phi} \omega_i J_{gm} - \rho \kappa_c \frac{\partial \omega_i}{\partial r} \right]
\end{equation}
%%%%%
%%%%%
%%%%%

\section{Viscosity}
Currently, the standard Arrhenius law is implemented. In order to pin the viscosity to a reference viscosity $\eta_0$ at a certain pressure $P_0$ and temperature $T_0$, it is used in the following form:
\begin{equation}
\ln ( \eta (P,T)) = \ln \eta_0 + \frac{E_a + V_a*P}{RT} - \frac{E_a + V_a P_0}{R T_0},
\end{equation}
for activation energy $E_a$ and activation volume $V_a$. This can be rewritten as
\begin{equation*}
\ln ( \eta (P,T)) = \ln \eta_0 + \frac{(E_a + V_a*(P_0 + \Delta P))*T_0 - (E_a + V_a*P_0)*(T_0 + \Delta T)}{R T_0 (\Delta T + T_0)}
\end{equation*}
for $\Delta P = P - P_0$ and $\Delta T = T - T_0$. If we write $\Delta T' = \Delta T/T_0$, we get
\begin{equation}
\ln ( \eta (P,T)) = \ln \eta_0 + \frac{V_a \Delta P - (E_a + V_a P_0)\Delta T'}{R T_0 (1 + \Delta T')}.
\end{equation}
Values can be specified in the input file, where $\eta_0$ should be specified in -log10visc\_sol, $P_0$ in -P0\_visc and $T_0$ in -T0\_visc. Currently, they are set to CMB values with $\eta0 = 10e22$, $T_0 = T_{CMB} \approx 4000$K and $P_0 = P_{CMB} \approx 138$ GPa. Can also mimic StagYY, where it is set to $P_0 = 0$, $T_0 = 1600$ and $\eta_0 = 10e19$.

\subsection{Compositionally dependent viscosity}
Viscosity is strongly dependent on the Si-abundance in the mantle. Very Si-rich mantles are much more viscous than very Mg-rich mantles. The compositional dependency is applied simply by adding a term to the viscosity, $\ln \eta_{new} = \ln \eta + \Delta \eta_c$. It depends on the Mg/Si-ratio, which is specified in the input file with -Mg\_Si, where you can enter 0.0 to switch it off. Usually, it is set to 1.08, the value for Earth. It is linearly dependent on Mg/Si in several steps:
\begin{equation}
\Delta \eta_c = 
\begin{cases}
2 & \text{Mg/Si} < 0.5 \\
\log(3.3) + (2 - \log(3.3))\frac{0.7 - \text{Mg/Si}}{0.2} & 0.5 \leq \text{Mg/Si} < 0.7 \\
\log(3.3)\frac{1 - \text{Mg/Si}}{0.3} & 0.7 \leq \text{Mg/Si} < 1.0 \\
\log(0.033)\frac{\text{Mg/Si}-1}{0.25} & 1.0 \leq \text{Mg/Si} < 1.25 \\
-2 + (\log(0.033) + 2)\frac{1.5 - \text{Mg/Si}}{0.25} & 1.25 \leq \text{Mg/Si} < 1.5 \\
-2 & \text{Mg/Si} \geq 1.5
\end{cases}.
\end{equation}
%It is centered around Mg/Si=1 here, but can easily be centered around different Mg/Si values by subtracting $\Delta \eta_c$ for the reference Mg/Si from the actual number. It is recommended to center it around the Mg/Si ratio of Earth (which is currently the case) so a viscosity profile based on Earth can be used.
The correction above is centered around Mg/Si = 1.0. If the reference viscosity profile is not for a planet with Mg/Si=1.0, then the compositional correction should be altered to compensate for the difference. This is done by subtracting the compositional correction of the composition for which the reference viscosity profile is calculated (usually Earth-like composition). The composition for which the reference viscosity profile has been calculated can be given in the options file as -Mg\_Si\_ref. This should be set to Earth-like composition as default, since most reference viscosity profiles are calculated for Earth. The compositional correction is stored in P visc\_ref\_comp.

\subsection{Depth-dependent activation volume}
Activation volume $V_a$ changes with depth. This change is already implemented in StagYY, and now also in SPIDER. The implementation and numbers are based on Antoine Rozel's paper, Continental crust formation on early Earth controlled by intrusive magmatism (Nature, 2017). It is described by
\begin{equation}
V_a(P) = V_0 \exp(- P/P_i),
\end{equation}
where $V_0$ is the same as the value for $V_a$ used before, and pressure scaling $P_i$ is given by Rozel et al.\ at $P_i=200$GPa in the lower mantle, and zero in the upper mantle. Currently, in SPIDER it is not possible yet to vary this value between UM and LM (or between layers), but that should not be difficult to implement. Currently, this part is controlled by two input parameters: -activation\_volume\_pressure\_dependency is used to switch this formula on or off (1 is on, any other integer is off), while -activation\_volume\_pressure\_scaling gives the scaling pressure $P_i$ for if the dependency is switched on. Currently it is set to 200e9 Pa (200 GPa).


Using this description for $V_a$ changes the equation for viscosity from equation \ref{eq:visc_constVa}, since the $V_a$ multiplied with $P$ is not the same as the one multiplied with $P_0$ in equation \ref{eq:visc_viscstep1}. Starting from the latter equation, we get
\begin{equation*}
\ln ( \eta (P,T)) = \ln \eta_0 + \frac{( V_a(P)*(P_0 + \Delta P))*T_0 -  V_a(P_0)*P_0*(T_0 + \Delta T) + E_a (T_0 - (T_0 + \Delta T))}{R T_0 (\Delta T + T_0)},
\end{equation*}
which can be slightly rewritten to the form which is implemented in SPIDER,
\begin{equation}
\ln ( \eta (P,T)) = \ln \eta_0 + \frac{V_a(P) \Delta P + P_0 \left( V_a(P) - V_a(P_0) (1 + \Delta T' ) \right) - E_a \Delta T' }{R T},
\label{eq:visc_varVa}
\end{equation}
since $T = T_0(1 + \Delta T' )$. Also, $V_a(P_0) =\exp(-P_0/P_i)$ is a constant throughout the simulation.

\section{Mixing length profile}
According to Kamata (2018) and Wagner et al.\ (2019), the classical mixing length profile is not able to reproduce realistic results, with Nusselt number and average temperature deviating by up to 60\% from 3D simulations. They came up with a way of parametrizing the mixing length profile to get more realistic results. For mantle thickness $D$, the profile can be characterized by two parameters: depth $a$ and size$b$, where the peak of the profile is at a depth of $a\cdot D$ km, and the size of the peak is $b \cdot D$ km. The profile consists of two linear lines from 0 at the top and bottom of the mantle to the peak of the profile. In the classical MLT, we have $a=b=0.5$. Kamata (2018) and Wagner et al. (2019) varied these numbers in their simulations to see which sets gives the most representative results.

\subsection{Kamata's results}
Kamata (2018) finds that the coefficients $a$ and $b$ depend on two parameters: relative mantle size $f = R_{CMB}/R_{top}$, which is about 0.55 for Earth (and is an input parameter for SPIDER), and viscosity contrast across the mantle $\gamma = \ln (\eta_{top}/\eta_{bottom})$.  His descriptions for the parameters are quadratic equations of $f$, $a,b = a_2,b_2 f^2 + a_1,b_1f + a_0,b_0$, where the coefficients depend on $\gamma$. (see equations 13-20 in his paper). He finds that the coefficients slightly depend on the Rayleigh number of the system, but not significantly enough to include it in the parametrization (see Figure 4 in his paper).

\subsection{Wagner et al.'s results}
Wagner et al.\ (2019) use a different parametrization in terms of $\alpha$ and $\beta$, which can be transformed to the original coefficients as $a = \beta/2$ and $b=\alpha/2$. They find a more complex relationship, which depends on the viscosity contrast and on the Rayleigh number of the system. They present a scaling law in their Figure 7 and Table 4,
\begin{equation}
\alpha = \left( a_0 - a_1 \gamma - a_2 \log(\text{Ra}) \right) \tanh \left( a_3 \log (\text{Ra}/\text{Ra}_c) \right),
\end{equation}
where Ra$_c$ is the critical Rayleigh number (which they present an approximation for as a function of $\gamma$). Their parametrization of $\beta$ depends on the dynamic regime. For the stagnant lid regime it is slightly simpler:
\begin{equation}
\beta = b_0 - b_1 \gamma - b_2 \log (\text{Ra}),
\end{equation}
while for the mobile and sluggish lids it's a more complex equation
\begin{equation}
\beta = b_0 - b_1  \tanh \left( \log(\text{Ra}) - b_2 - b_3 \gamma^{b_4} \right).
\end{equation}
Values for the numbers are given in their Table 4, for both Bottom-heated and Mixed heated models (as long as internal heating by radiogenic elements is switched on, we're in the mixed heating regime).

\section{Parameterised fluxes}
\input{input/parameterised_fluxes}

\section{Derivations in Abe (1993)}
\input{input/abe1993}

\section{Internal heating}
\input{input/internal_heating}

\section{Atmosphere}
\input{input/atmosphere}

\section{Boundary conditions}
\input{input/boundary_conditions}

\section{Hybrid mantle EOS from multiple data sources}
\input{input/hybrid_eos}

\section{Toy model}
\input{input/toy_model}

\appendix
\input{input/appendix}

\bibliography{refs}
\bibliographystyle{plainnat}

\end{document}
