\documentclass[12pt,notitlepage]{article}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{natbib}
\usepackage{tikz}
\usepackage{empheq}
\usepackage{cases}
\usepackage{comment}

\usepackage{titlesec}

\setcounter{secnumdepth}{4}

\titleformat{\paragraph}
{\normalfont\normalsize\bfseries}{\theparagraph}{1em}{}
\titlespacing*{\paragraph}
{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}

\usepackage{xcolor}
\usepackage{soul}
\definecolor{redhl}{rgb}{1,0.5,0.5}
\definecolor{bluehl}{rgb}{0.75,0.75,1}
\definecolor{greenhl}{rgb}{0.5,1.0,0.5}
\definecolor{tealhl}{rgb}{0.6,0.8,0.8}
\newcommand{\awnote}[1]{\sethlcolor{redhl}\hl{(AW: #1)}}
\newcommand{\dbnote}[1]{\sethlcolor{bluehl}\hl{(DB: #1)}}
\newcommand{\psnote}[1]{\sethlcolor{greenhl}\hl{(PS: #1)}}
\newcommand{\tknote}[1]{\sethlcolor{tealhl}\hl{(TK: #1)}}
\newcommand{\boxedeq}[2]{\begin{empheq}[box={\fboxsep=6pt\fbox}]{align}\label{#1}#2\end{empheq}}

% for atmosphere / volatiles
%\newcommand{\water}[0]{H$_2$O}
%\newcommand{\dih}[0]{H$_2$}

\newcommand{\myemph}[1]{\textbf{#1}}
\begin{document}

\title{Manual and extended notes for SPIDER\\[2ex] \includegraphics[width=0.5\textwidth]{figs/spider_logo}}
\author{Dan J. Bower}

\pagenumbering{Roman}

\maketitle

\tableofcontents
\newpage
\listoffigures
\newpage
\listoftables
\newpage
\pagenumbering{arabic}

%\begin{abstract}
%The abstract text goes here.
%\end{abstract}

%\section{Preface}
%\input{input/preface}
%\clearpage

%\section{Thermodynamics}
%\input{input/basic_thermodynamics}
%\clearpage

%\section{Conservation of chemical species}
%\input{input/transport}
%\clearpage

%\section{Material properties}
%\input{input/material_properties}
%\clearpage

\section{Mass coordinates}
\input{input/mass_coordinates}
\clearpage




%\subsubsection{Aside: Sensitivity of EOS to parameters}
%Differentiate with respect to $\beta$ to find the sensitivity of the average density of the shell to the compressibility of the material within the shell.  Again, easiest to do using Wolfram Alpha:
%\begin{verbatim}
%differentiate integrate r^2 exp(-beta*r) dr from r=a to r=b wrt beta
%\end{verbatim}
%\begin{align}
%\frac{d\rho_0}{d\beta} &= \frac{d}{d\beta} \left( \int_{r_i}^{r_o} r^2 \exp( -\beta r) dr \right)\\
%&= e^{- \beta r_i} \left(-\frac{r_i^3}{\beta}-\frac{3r_i^2}{\beta^2}-\frac{6r_i}{\beta^3} \right) + \frac{e^{\beta(-r_i-r_o)}(6e^{\beta r_i} -6e^{\beta r_o})}{\beta^4} + e^{- \beta r_o} \left(\frac{r_o^3}{\beta}+\frac{3r_o^2}{\beta^2}+\frac{6r_o}{\beta^3} \right)
%\end{align}
%\begin{verbatim}
%integrate 3*c*e^(beta)/(1-0.55^3)*r^2 exp(-beta*r) dr from r=0.55 to r=1.0
%\end{verbatim}
%\subsection{Notation}
%Uppercase quantities ($U$, $J$) represents quantities relative to a stationary reference frame.  Lower case quantities are relative to a reference frame moving with the barycentric velocity, $U$.
%%%%
%%%%

%%% TO REMOVE %%%
% this doesn't seem to be going anywhere, and should be eliminated
% when the switch to mass coordinates has been made.
%\section{Analysis of the Lagrangian derivative}
%The LHS is:
%\begin{equation}
%\frac{Ds}{Dt} = \frac{\partial s}{\partial t} + \vec{U} \cdot \nabla s
%\end{equation}
%But in SPIDER (at present) we ignore the second term which is the convective derivative, i.e. the change in entropy due to transport by the flow.  Let's try and determine this second term now.  Use:
%\begin{equation}
%\vec{U} = \phi \vec{U}_m + (1-\phi) \vec{U}_s
%\end{equation}
%and then sub in to eliminate $U_m-U_s$ by using:
%\begin{equation}
%\vec{J}_m = \rho \phi (1-\phi)(\vec{U}_m-\vec{U}_s)
%\end{equation}
%To get:
%\begin{equation}
%\vec{U} \cdot \nabla s = \frac{\vec{J}_m}{\rho(1-\phi)} \cdot \nabla s + \vec{U}_s \cdot \nabla s 
%\end{equation}
%So the first term is only important when relative motion of melt-solid becomes significant, which is around and below the rheological transition.  Now need to find an expression for $\vec{U}_s$!

\subsection{Gravitational potential energy}
The gravitational potential energy per unit mass is:
\begin{equation}
E_{\rm grav} = \frac{\partial U_{\rm grav}}{\partial m} = - \frac{G M(r)}{r} = - |g(r)|r
\end{equation}
where $U_{\mathrm{grav}}$ is gravitational energy, $m$ mass, $G$ gravitational constant, $r$ radius from centre of mass, $M(r)$ integrated mass from centre of mass to $r$, and $g(r)$ acceleration due to gravity as a function of $r$.
Thus, melting influences gravitational potential energy through its affect on $g(r)$, and because $g(r)$ is an integrated quantity it is not sensitive to small changes to the density distribution.  We therefore neglect changes in $E_{\mathrm{grav}}$ for silicate melting in a magma ocean.  However, this term should be included to model mantle-core differentiation because in this case the density contrast between solid and melt components is large.
%%%%
%%%%
%%%%

%%%%%
%%%%%
%%%%%
\section{Hydrostatic equilibrium}
\label{sect:hydrostatic}
\begin{equation}
\frac{dp(r)}{dr} = g(r) \rho(r) = -G \frac{M(r)}{r^2}\rho(r)
\end{equation}
Multiply by $r^2/\rho$ and differentiate with respect to $r$:
\begin{equation}
\frac{d}{dr} \left( \frac{r^2}{\rho(r)} \frac{dp(r)}{dr} \right) = -G \frac{dM(r)}{dr} = -G 4 \pi r^2 \rho(r)
\end{equation}
Rearranging this becomes:
\begin{equation}
\frac{1}{r^2} \frac{d}{dr} \left( \frac{r^2}{\rho}\frac{dp}{dr} \right) = -4 \pi G \rho
\end{equation}
Combined with an EOS of the form $p=p(\rho)$, this is an ordinary second order differential equation for the density or pressure.
%%%%%
%%%%%
%%%%%
\section{Eq. in \cite{ABE93}}
The conversion to mass units means that the Lagrangian derivative becomes the partial derivative:
\begin{equation}
\frac{\partial \omega_i}{\partial t} = -4 \pi \frac{\partial}{\partial m} r^2 \left[ \frac{1-K_i}{K_i+(1-K_i)\phi} \omega_i J_{gm} - \rho \kappa_c \frac{\partial \omega_i}{\partial r} \right]
\end{equation}
%%%%%
%%%%%
%%%%%

\section{Viscosity}
Currently, the standard Arrhenius law is implemented.  To pin the viscosity to a reference viscosity $\eta_0$ at pressure $P_0$ and temperature $T_0$, we use:
\begin{equation}
\log_{10} ( \eta (P,T)) = \log_{10} \eta_0 + \frac{E_a + V_aP}{RT} - \frac{E_a + V_a P_0}{R T_0},
\label{eq:viscnopin}
\end{equation}
for activation energy $E_a$ and activation volume $V_a$.  This can be rewritten as
\begin{equation*}
\log_{10} ( \eta (P,T)) = \log_{10} \eta_0 + \frac{(E_a + V_a(P_0 + \Delta P))T_0 - (E_a + V_aP_0)(T_0 + \Delta T)}{R T_0 (\Delta T + T_0)}
\end{equation*}
for $\Delta P = P - P_0$ and $\Delta T = T - T_0$. If we write $\Delta T' = \Delta T/T_0$, we get
\begin{equation}
\log_{10} ( \eta (P,T)) = \log_{10} \eta_0 + \frac{V_a \Delta P - (E_a + V_a P_0)\Delta T'}{R T_0 (1 + \Delta T')}.
\end{equation}
\begin{equation}
\log_{10} ( \eta (P,T)) = \log_{10} \eta_0 + \frac{-E_a \Delta T' + V_a (\Delta P - P_0 \Delta T')}{R T}.
\end{equation}
Now the form is similar to Eq.~\ref{eq:viscnopin} if the last term was ignored (i.e., no assumed pinning).
Values can be specified in the input file, where $\eta_0$ is the reference viscosity at P--T conditions given by $P_0$ and $T_0$.  Recommended CMB values are $\eta_0 = 10^{22}$, $T_0 = T_{CMB} \approx 4000$K and $P_0 = P_{CMB} \approx 138$ GPa.  Another option is to adopt the convention used in StagYY, where $P_0 = 0$, $T_0 = 1600$ and $\eta_0 = 10^{19}$.  In this later case, the viscosity structure is pinned to the top of the 1600 K adiabat.

\subsection{Compositionally dependent viscosity}
Viscosity is strongly dependent on the Si-abundance in the mantle. Very Si-rich mantles are much more viscous than very Mg-rich mantles. The compositional dependency is applied simply by adding a term to the viscosity, $\ln \eta_{new} = \ln \eta + \Delta \eta_c$. It depends on the Mg/Si-ratio, which is specified in the input file with -Mg\_Si, where you can enter 0.0 to switch it off. Usually, it is set to 1.08, the value for Earth. It is linearly dependent on Mg/Si in several steps:
\begin{equation}
\Delta \eta_c = 
\begin{cases}
2 & \text{Mg/Si} < 0.5 \\
\log(3.3) + (2 - \log(3.3))\frac{0.7 - \text{Mg/Si}}{0.2} & 0.5 \leq \text{Mg/Si} < 0.7 \\
\log(3.3)\frac{1 - \text{Mg/Si}}{0.3} & 0.7 \leq \text{Mg/Si} < 1.0 \\
\log(0.033)\frac{\text{Mg/Si}-1}{0.25} & 1.0 \leq \text{Mg/Si} < 1.25 \\
-2 + (\log(0.033) + 2)\frac{1.5 - \text{Mg/Si}}{0.25} & 1.25 \leq \text{Mg/Si} < 1.5 \\
-2 & \text{Mg/Si} \geq 1.5
\end{cases}.
\end{equation}
%It is centered around Mg/Si=1 here, but can easily be centered around different Mg/Si values by subtracting $\Delta \eta_c$ for the reference Mg/Si from the actual number. It is recommended to center it around the Mg/Si ratio of Earth (which is currently the case) so a viscosity profile based on Earth can be used.
The correction above is centered around Mg/Si = 1.0. If the reference viscosity profile is not for a planet with Mg/Si=1.0, then the compositional correction should be altered to compensate for the difference. This is done by subtracting the compositional correction of the composition for which the reference viscosity profile is calculated (usually Earth-like composition). The composition for which the reference viscosity profile has been calculated can be given in the options file as -Mg\_Si\_ref. This should be set to Earth-like composition as default, since most reference viscosity profiles are calculated for Earth. The compositional correction is stored in P visc\_ref\_comp.

\subsection{Depth-dependent activation volume}
Activation volume $V_a$ changes with depth. This change is already implemented in StagYY, and now also in SPIDER. The implementation and numbers are based on Antoine Rozel's paper, Continental crust formation on early Earth controlled by intrusive magmatism (Nature, 2017). It is described by
\begin{equation}
V_a(P) = V_0 \exp(- P/P_i),
\end{equation}
where $V_0$ is the same as the value for $V_a$ used before, and pressure scaling $P_i$ is given by Rozel et al.\ at $P_i=200$GPa in the lower mantle, and zero in the upper mantle. Currently, in SPIDER it is not possible yet to vary this value between UM and LM (or between layers), but that should not be difficult to implement. Currently, this part is controlled by two input parameters: -activation\_volume\_pressure\_dependency is used to switch this formula on or off (1 is on, any other integer is off), while -activation\_volume\_pressure\_scaling gives the scaling pressure $P_i$ for if the dependency is switched on. Currently it is set to 200e9 Pa (200 GPa).


Using this description for $V_a$ changes the equation for viscosity from equation \ref{eq:visc_constVa}, since the $V_a$ multiplied with $P$ is not the same as the one multiplied with $P_0$ in equation \ref{eq:visc_viscstep1}. Starting from the latter equation, we get
\begin{equation*}
\ln ( \eta (P,T)) = \ln \eta_0 + \frac{( V_a(P)*(P_0 + \Delta P))*T_0 -  V_a(P_0)*P_0*(T_0 + \Delta T) + E_a (T_0 - (T_0 + \Delta T))}{R T_0 (\Delta T + T_0)},
\end{equation*}
which can be slightly rewritten to the form which is implemented in SPIDER,
\begin{equation}
\ln ( \eta (P,T)) = \ln \eta_0 + \frac{V_a(P) \Delta P + P_0 \left( V_a(P) - V_a(P_0) (1 + \Delta T' ) \right) - E_a \Delta T' }{R T},
\label{eq:visc_varVa}
\end{equation}
since $T = T_0(1 + \Delta T' )$. Also, $V_a(P_0) =\exp(-P_0/P_i)$ is a constant throughout the simulation.

\section{Mixing length profile}
According to Kamata (2018) and Wagner et al.\ (2019), the classical mixing length profile is not able to reproduce realistic results, with Nusselt number and average temperature deviating by up to 60\% from 3D simulations. They came up with a way of parametrizing the mixing length profile to get more realistic results. For mantle thickness $D$, the profile can be characterized by two parameters: depth $a$ and size$b$, where the peak of the profile is at a depth of $a\cdot D$ km, and the size of the peak is $b \cdot D$ km. The profile consists of two linear lines from 0 at the top and bottom of the mantle to the peak of the profile. In the classical MLT, we have $a=b=0.5$. Kamata (2018) and Wagner et al. (2019) varied these numbers in their simulations to see which sets gives the most representative results.

\subsection{Kamata's results}
Kamata (2018) finds that the coefficients $a$ and $b$ depend on two parameters: relative mantle size $f = R_{CMB}/R_{top}$, which is about 0.55 for Earth (and is an input parameter for SPIDER), and viscosity contrast across the mantle $\gamma = \ln (\eta_{top}/\eta_{bottom})$.  His descriptions for the parameters are quadratic equations of $f$, $a,b = a_2,b_2 f^2 + a_1,b_1f + a_0,b_0$, where the coefficients depend on $\gamma$. (see equations 13-20 in his paper). He finds that the coefficients slightly depend on the Rayleigh number of the system, but not significantly enough to include it in the parametrization (see Figure 4 in his paper).

\subsection{Wagner et al.'s results}
Wagner et al.\ (2019) use a different parametrization in terms of $\alpha$ and $\beta$, which can be transformed to the original coefficients as $a = \beta/2$ and $b=\alpha/2$. They find a more complex relationship, which depends on the viscosity contrast and on the Rayleigh number of the system. They present a scaling law in their Figure 7 and Table 4,
\begin{equation}
\alpha = \left( a_0 - a_1 \gamma - a_2 \log(\text{Ra}) \right) \tanh \left( a_3 \log (\text{Ra}/\text{Ra}_c) \right),
\end{equation}
where Ra$_c$ is the critical Rayleigh number (which they present an approximation for as a function of $\gamma$). Their parametrization of $\beta$ depends on the dynamic regime. For the stagnant lid regime it is slightly simpler:
\begin{equation}
\beta = b_0 - b_1 \gamma - b_2 \log (\text{Ra}),
\end{equation}
while for the mobile and sluggish lids it's a more complex equation
\begin{equation}
\beta = b_0 - b_1  \tanh \left( \log(\text{Ra}) - b_2 - b_3 \gamma^{b_4} \right).
\end{equation}
Values for the numbers are given in their Table 4, for both Bottom-heated and Mixed heated models (as long as internal heating by radiogenic elements is switched on, we're in the mixed heating regime).

\section{Parameterised fluxes}
\input{input/parameterised_fluxes}

\section{Derivations in Abe (1993)}
\input{input/abe1993}

\section{Internal heating}
\input{input/internal_heating}

\section{Atmosphere}
\input{input/atmosphere}

\section{Boundary conditions}
\input{input/boundary_conditions}

\section{Hybrid mantle EOS from multiple data sources}
\input{input/hybrid_eos}

\section{Toy model}
\input{input/toy_model}

\appendix
\input{input/appendix}

\bibliography{refs}
\bibliographystyle{plainnat}

%\bibliographystyle{utphys}
%\bibliographystyle{kp}

\end{document}
